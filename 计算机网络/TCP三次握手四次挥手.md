# TCP三次握手四次挥手

 两张图记好，要能练到复刻画出来！

![img](https://vingdream.cn/static/abd8f3ba67e9864d180798bcf37bab73.jpg) 

![img](https://vingdream.cn/static/ec383f1352a3c7e76ad5aaa4205c1779.jpg) 


### 为什么建立连接是三次握手，而关闭连接却是四次挥手呢？

这是因为服务端在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文里返回给客户端，相当于第二次和第三次包含在一起了。

而关闭连接时，当收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，可能同时自己还需要发送数据。

### 二次握手为什么不行

因为两次握手仅仅只是确认了客户端的连接请求已经收到，但是二次握手服务端发送的SYN数据没有返回ACK，服务端可能不知道自己是否与客户端的连接已经建立成功，可能会等待客户端的重发请求，因为认为连接没有建立成功，而忽略客户端发来的其他请求等，同时客户端也会重复发送报文。

### 三次挥手为什么不行

在于TCP链接是全双工通道，需要双向关闭。客户端向服务端发送关闭请求，表示客户端不再发送数据，但是服务端仍然可以向客户端发送数据，在发送完数据后，如果三次挥手，服务端只是发送了FIN请求，还没有收到ACK请求，无法端口是否关闭，会对资源造成浪费。

### TIME_WAIT的作用

是为了保证服务端能收到客户端回应的ACK报文，因为网络是不能保证是可靠的，如果ACK回应报文丢失，服务端那边会重复发送FIN报文，如果在TIMEWAIT时间内收到新的FIN报文，就说明之前的ACK报文丢失了，这时候就需要重置TIMEWAIT，当过完2MSL（报文最大生存时间）后，没有收到新的FIN报文，就说明服务器已经正确收到ACK报文了。

