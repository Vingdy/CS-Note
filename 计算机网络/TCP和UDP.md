# TCP与UDP

## 区别与用途

| 类型              | 区别       | 可靠性           | 报头长度 |
| ----------------- | ---------- | ---------------- | -------- |
| TCP传输控制协议   | 面向字节流 | 可靠，需要连接   | 20个字节 |
| UDP用户数据报协议 | 面向数据报 | 不可靠，无需连接 | 8个字节  |

TCP用于要实现可靠性传输的情况，例如网页浏览，下载

UDP用于要实现高速传输与实时性要求高的情况，例如QQ、会议系统

附：部分游戏会用kdp，即一种实现可靠传输的UDP

## 为什么TCP是可靠的

①需要连接（即三次握手四次挥手）

②失序整理（乱序报文整理）

③超时重传（即ACK机制，当长时间没有收到ACK报文认为丢失，重传报文，）

④流量控制（滑动窗口，当收到ACK中包含的窗口大小值后才滑动）

⑤拥塞控制（拥塞窗口与门限值的关系，四个算法：慢开始（初始1，确认加一倍即*2），拥塞避免（到达门限，确认只加一即+1）；快重传，快恢复：后面报文已收到三次要求确认前面的某个报文即重传，同时门限值和拥塞窗口减半，开始拥塞避免）

## TCP三次握手四次挥手

 两张图记好，要能练到复刻画出来！

![img](https://vingdream.cn/static/abd8f3ba67e9864d180798bcf37bab73.jpg) 

![img](https://vingdream.cn/static/ec383f1352a3c7e76ad5aaa4205c1779.jpg) 


### 为什么建立连接是三次握手，而关闭连接却是四次挥手呢？

这是因为服务端在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文里返回给客户端，相当于第二次和第三次包含在一起了。

而关闭连接时，当收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，可能同时自己还需要发送数据。

### 二次握手为什么不行

因为两次握手仅仅只是确认了客户端的连接请求已经收到，但是二次握手服务端发送的SYN数据没有返回ACK，服务端可能不知道自己是否与客户端的连接已经建立成功，可能会等待客户端的重发请求，因为认为连接没有建立成功，而忽略客户端发来的其他请求等，同时客户端也会重复发送报文。

### 三次挥手为什么不行

在于TCP链接是全双工通道，需要双向关闭。客户端向服务端发送关闭请求，表示客户端不再发送数据，但是服务端仍然可以向客户端发送数据，在发送完数据后，如果三次挥手，服务端只是发送了FIN请求，还没有收到ACK请求，无法端口是否关闭，会对资源造成浪费。

### TIME_WAIT的作用

是为了保证服务端能收到客户端回应的ACK报文，因为网络是不能保证是可靠的，如果ACK回应报文丢失，服务端那边会重复发送FIN报文，如果在TIMEWAIT时间内收到新的FIN报文，就说明之前的ACK报文丢失了，这时候就需要重置TIMEWAIT，当过完2MSL（报文最大生存时间）后，没有收到新的FIN报文，就说明服务器已经正确收到ACK报文了。

## TCP的LISTEN状态

 表示服务器端的某个SOCKET处于监听状态，可以接受连接了 

## TCP的WAIT-CLOSE状态

这时候是看你是否还有数据发送给对方，如果没有的话，就发送FIN报文给对方请求关闭连接。简单理解就是等待你去关闭连接。 

## UDP是不可靠，怎么使得UDP可靠

为UDP的每个包添加序号，并补充序号确认与重传机制，确认收到包后发送确认信息后再发送下一个包